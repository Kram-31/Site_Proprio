---
import Layout from '../layouts/Layout.astro';
import SectionTitle from '../components/SectionTitle.astro';
import TattooCard from '../components/TattooCard.astro';
import { supabase } from '../lib/supabase';

// Fetch tattoos from Supabase
const { data: fetchedTattoos } = await supabase
  .from('tattoos')
  .select('*')
  .eq('status', 'done')
  .order('published_date', { ascending: false });

const tattoos = fetchedTattoos || [];
const allTags = [...new Set(tattoos.flatMap(t => t.tags || []))];
---

<Layout title="L'Art Mûri | Galerie">
    <section class="pt-32 pb-12 px-4 bg-[#050505] min-h-screen">
        <SectionTitle title="Le Portfolio" subtitle="Galerie" />
        
        <!-- Filters -->
        <div class="max-w-7xl mx-auto mb-12 flex flex-col items-center gap-6">
            <div class="flex flex-wrap justify-center gap-4">
                <button class="filter-btn active px-6 py-2 border border-white bg-white text-black font-heading font-bold uppercase tracking-widest hover:bg-[var(--color-primary)] hover:text-white transition-all" data-filter="all">
                    Tout
                </button>
                {allTags.map(tag => (
                    <button class="filter-btn px-6 py-2 border border-white/30 text-white font-heading font-bold uppercase tracking-widest hover:border-white hover:bg-white hover:text-black transition-all" data-filter={tag}>
                        {tag}
                    </button>
                ))}
            </div>
            
            <!-- Healed Toggle -->
            <label class="flex items-center gap-3 cursor-pointer group">
                <div class="relative">
                    <input type="checkbox" id="healed-toggle" class="sr-only peer">
                    <div class="w-14 h-8 bg-gray-800 border border-white/30 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-[var(--color-primary)] rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-7 after:w-7 after:transition-all peer-checked:bg-[var(--color-primary)]"></div>
                </div>
                <span class="font-heading font-bold uppercase tracking-widest text-sm text-gray-400 group-hover:text-white transition-colors">Cicatrisés uniquement</span>
            </label>
        </div>

        <!-- Gallery Grid -->
        <div class="max-w-7xl mx-auto grid md:grid-cols-2 lg:grid-cols-3 gap-8" id="gallery-grid">
            {tattoos.map(tattoo => (
                <div class="tattoo-item group" data-tags={JSON.stringify(tattoo.tags)}>
                    <TattooCard 
                        title={tattoo.title}
                        image={tattoo.image_url}
                        tags={tattoo.tags}
                        id={tattoo.id} 
                    />
                </div>
            ))}
        </div>
        
        <div id="no-results" class="hidden text-center py-20">
            <p class="font-heading text-2xl uppercase text-gray-500">Aucun tatouage ne correspond à ces filtres.</p>
        </div>
    </section>
</Layout>

<script>
    const filterBtns = document.querySelectorAll('.filter-btn');
    const healedToggle = document.getElementById('healed-toggle') as HTMLInputElement;
    const items = document.querySelectorAll('.tattoo-item');
    const noResults = document.getElementById('no-results');

    let currentFilter = 'all';
    let showHealedOnly = false;

    function filterItems() {
        let visibleCount = 0;

        items.forEach(item => {
            const tags = JSON.parse((item as HTMLElement).dataset.tags || '[]');
            const isHealed = (item as HTMLElement).dataset.healed === 'true'; // Depends on how we mark healed. simpler to just use tags.
            // Let's assume 'healed' is just a tag for now, but the toggle forces it.
            // Actually, if healed is a separate boolean in CMS it would be better, but mapped to tags in plan.
            // I'll assume 'healed' is a tag value.

            const matchesFilter = currentFilter === 'all' || tags.includes(currentFilter);
            const matchesHealed = !showHealedOnly || tags.includes('healed'); 

            if (matchesFilter && matchesHealed) {
                (item as HTMLElement).style.display = 'block';
                // Add fade in animation?
                 (item as HTMLElement).style.opacity = '1';
                 (item as HTMLElement).style.transform = 'scale(1)';
                visibleCount++;
            } else {
                (item as HTMLElement).style.display = 'none';
                 (item as HTMLElement).style.opacity = '0';
                 (item as HTMLElement).style.transform = 'scale(0.95)';
            }
        });

        if (noResults) {
            noResults.style.display = visibleCount === 0 ? 'block' : 'none';
        }
    }

    filterBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            // Update active state
            filterBtns.forEach(b => {
                b.classList.remove('bg-white', 'text-black', 'active');
                b.classList.add('text-white', 'bg-transparent');
            });
            btn.classList.remove('bg-transparent', 'text-white');
            btn.classList.add('bg-white', 'text-black', 'active');

            currentFilter = btn.getAttribute('data-filter') || 'all';
            filterItems();
        });
    });

    healedToggle?.addEventListener('change', (e) => {
        showHealedOnly = (e.target as HTMLInputElement).checked;
        filterItems();
    });
</script>
