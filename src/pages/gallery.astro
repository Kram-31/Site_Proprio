---
import Layout from '../layouts/Layout.astro';
import SectionTitle from '../components/SectionTitle.astro';
import TattooCard from '../components/TattooCard.astro';
import { supabase } from '../lib/supabase';

// Fetch tattoos from Supabase
const { data: fetchedTattoos } = await supabase
  .from('tattoos')
  .select('*')
  .eq('status', 'done')
  .order('published_date', { ascending: false });

const tattoos = fetchedTattoos || [];
const allTags = [...new Set(tattoos.flatMap(t => t.tags || []))];
---

<Layout title="L'Art Mûrit | Galerie">
    <section class="pt-32 pb-12 px-4 bg-[#050505] min-h-screen">
        <SectionTitle title="Le Portfolio" subtitle="Galerie" />
        
        <!-- Filters -->
        <div class="max-w-7xl mx-auto mb-12 flex flex-col items-center gap-6">
            <div class="flex flex-wrap justify-center gap-4">
                <button class="filter-btn active px-6 py-2 border border-white bg-white text-black font-heading font-bold uppercase tracking-widest hover:bg-[var(--color-primary)] hover:text-white transition-all" data-filter="all">
                    Tout
                </button>
                {allTags.map(tag => (
                    <button class="filter-btn px-6 py-2 border border-white/30 text-white font-heading font-bold uppercase tracking-widest hover:border-white hover:bg-white hover:text-black transition-all" data-filter={tag}>
                        {tag}
                    </button>
                ))}
            </div>
            
        </div>

        <!-- Gallery Grid -->
        <div class="max-w-7xl mx-auto grid md:grid-cols-2 lg:grid-cols-3 gap-8" id="gallery-grid">
            {tattoos.map(tattoo => (
                <div class="tattoo-item group" data-tags={JSON.stringify(tattoo.tags)}>
                    <TattooCard 
                        title={tattoo.title}
                        image={tattoo.image_url}
                        tags={tattoo.tags}
                        id={tattoo.id} 
                    />
                </div>
            ))}
        </div>
        
        <div id="no-results" class="hidden text-center py-20">
            <p class="font-heading text-2xl uppercase text-gray-500">Aucun tatouage ne correspond à ces filtres.</p>
        </div>
    </section>
</Layout>

<script>
    const filterBtns = document.querySelectorAll('.filter-btn');
    const items = document.querySelectorAll('.tattoo-item');
    const noResults = document.getElementById('no-results');

    let currentFilter = 'all';

    function filterItems() {
        let visibleCount = 0;

        items.forEach(item => {
            const tags = JSON.parse((item as HTMLElement).dataset.tags || '[]');
            
            const matchesFilter = currentFilter === 'all' || tags.includes(currentFilter);

            if (matchesFilter) {
                (item as HTMLElement).style.display = 'block';
                // Add fade in animation?
                 (item as HTMLElement).style.opacity = '1';
                 (item as HTMLElement).style.transform = 'scale(1)';
                visibleCount++;
            } else {
                (item as HTMLElement).style.display = 'none';
                 (item as HTMLElement).style.opacity = '0';
                 (item as HTMLElement).style.transform = 'scale(0.95)';
            }
        });

        if (noResults) {
            noResults.style.display = visibleCount === 0 ? 'block' : 'none';
        }
    }

    filterBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            // Update active state
            filterBtns.forEach(b => {
                b.classList.remove('bg-white', 'text-black', 'active');
                b.classList.add('text-white', 'bg-transparent');
            });
            btn.classList.remove('bg-transparent', 'text-white');
            btn.classList.add('bg-white', 'text-black', 'active');

            currentFilter = btn.getAttribute('data-filter') || 'all';
            filterItems();
        });
    });
</script>
